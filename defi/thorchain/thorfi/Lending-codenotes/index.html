<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>THORChain Lending Code Walkthrough notes - GrassRoots Crypto</title>
<meta name="description" content="I am keeping an eye on THORFi lending and trying to push a plan for its release. There is a lot of discussion around the pros/cons of lending, so I would like to see a comprehensive testing and review process. Learn more abount the risks of lending here">


  <meta name="author" content="Chris">
  
  <meta property="article:author" content="Chris">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="GrassRoots Crypto">
<meta property="og:title" content="THORChain Lending Code Walkthrough notes">
<meta property="og:url" content="https://grassrootscrypto.io/defi/thorchain/thorfi/Lending-codenotes/">


  <meta property="og:description" content="I am keeping an eye on THORFi lending and trying to push a plan for its release. There is a lot of discussion around the pros/cons of lending, so I would like to see a comprehensive testing and review process. Learn more abount the risks of lending here">





  <meta name="twitter:site" content="@GrassRootsio">
  <meta name="twitter:title" content="THORChain Lending Code Walkthrough notes">
  <meta name="twitter:description" content="I am keeping an eye on THORFi lending and trying to push a plan for its release. There is a lot of discussion around the pros/cons of lending, so I would like to see a comprehensive testing and review process. Learn more abount the risks of lending here">
  <meta name="twitter:url" content="https://grassrootscrypto.io/defi/thorchain/thorfi/Lending-codenotes/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2023-02-21T00:00:00+10:30">






<link rel="canonical" href="https://grassrootscrypto.io/defi/thorchain/thorfi/Lending-codenotes/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "GrassRoots Crypto",
      "url": "https://grassrootscrypto.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="GrassRoots Crypto Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/Grassroots_Crypto_Logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          GrassRoots Crypto
          <span class="site-subtitle">Teaching people about Crypto!</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/services/" title="What GrassRoots Crypto can do for you?">Services</a>
            </li><li class="masthead__menu-item">
              <a href="/ReferralLinks/">Referral Links</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/search/">Search</a>
            </li><li class="masthead__menu-item">
              <a href="/disclaimer/" title="Disclaimer, Disclosre and Copyright!">Disclaimer</a>
            </li><li class="masthead__menu-item">
              <a href="/sitemap/">Sitemap</a>
            </li><li class="masthead__menu-item">
              <a href="/THORChainDiagrams/" title="THORChain Diagrams">Diagrams</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="THORChain Lending Code Walkthrough notes">
    <meta itemprop="description" content="I am keeping an eye on THORFi lending and trying to push a plan for its release. There is a lot of discussion around the pros/cons of lending, so I would like to see a comprehensive testing and review process.Learn more abount the risks of lending here">
    <meta itemprop="datePublished" content="2023-02-21T00:00:00+10:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">THORChain Lending Code Walkthrough notes
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>I am keeping an eye on THORFi lending and trying to push a plan for its release. There is a lot of discussion around the pros/cons of lending, so I would like to see a comprehensive testing and review process.
<a href="/defi/thorchain/thorfi/THORFi-Risks-Explained/">Learn more abount the risks of lending here</a></p>

<p>The code is in review at moment across three branches.</p>

<h2 id="mrs">MRs</h2>
<ol>
  <li>https://gitlab.com/thorchain/thornode/-/merge_requests/2713 (Lending)</li>
  <li>https://gitlab.com/thorchain/thornode/-/merge_requests/2658 (Virtual pool gets generate at the beginning of each swap)</li>
  <li>https://gitlab.com/thorchain/thornode/-/merge_requests/2723 (Circuit Breaker)</li>
</ol>

<h2 id="code-walkthrough-nodes">Code walkthrough nodes</h2>

<h3 id="derived-asset-virtual-pool-recalc-pre-swap"><a href="https://www.youtube.com/watch?v=Wke82WgK8Ao">Derived Asset Virtual Pool, recalc pre swap</a></h3>
<ol>
  <li>Has derived asset type (which is already used for TOR)</li>
  <li>V Pool spawned twice. 1. on begin block to allow API query (to allow lending quotes). 2. On v pool swap as required, calcs pool depth to determine the exact slip.</li>
  <li>Virtual Pool depts are re-calculated before every Virtual Pool swap, so no sandwich attacks or swap queue manipulation is possible.</li>
  <li>RUNE slip is fee is burnt.</li>
</ol>

<h3 id="lending-open-and-close-loans"><a href="https://www.youtube.com/watch?v=8qCiyLy4YEw">Lending Open and Close Loans</a></h3>
<ol>
  <li>Min out will be added for min loan amount (open/close), like LIM for a swap. Will be in a different but provisions allowed for it in msg structures.</li>
  <li>5 new mimirs
    <ol>
      <li>Min CR</li>
      <li>Max CR</li>
      <li>Pause Loans - stop open and close loans</li>
      <li>LoanRepaymentMaturity - enable min time for loan open.</li>
      <li>CRPoolMultipler - cap collateral in a pool</li>
      <li>EnableDerivedAssets</li>
      <li>(MaxRuneSupply for circuit breaker but no in code)</li>
    </ol>
  </li>
  <li>Loan Open message
    <ol>
      <li>Has affiliate for first L1 swap.</li>
      <li>Has Dex aggregation support to taking out the debit (target asset)</li>
    </ol>
  </li>
  <li>Loan Close message
    <ol>
      <li>Can pay off with any asset (is converted to TOR)</li>
    </ol>
  </li>
  <li>Data for total pool collateral is collected and published in pool and pools endpoints.</li>
  <li>New Memos for loan open and close with an example</li>
  <li>New events emitted on loan open and repayment.</li>
  <li>Has collateral up and down (13:45) - gives better data over time and allows credit rollover for new loan when overpaid. (though the 4 vars are not in the current code base)</li>
  <li>Anyone can payoff anyone elseâ€™s loan, no restrictions.</li>
  <li>Loan Close: Asset in calls LoanRepayment_handler that calls Swap handler (to swap L1 to TOR) that then calls LoanRepayment_handler after asset in has been swapped to TOR - thus and LoanRepayement_handler is recursive. Be good to map thatin a digram</li>
</ol>

<h3 id="circuit-breaker-part-1"><a href="https://www.youtube.com/watch?v=e6gZ77DdMrc">Circuit Breaker Part 1</a></h3>
<ol>
  <li>Part 1: For loan close, will not mint Rune beyond 500 mil, checks native supply before minting new RUNE. If over, will move RUNE from the reserve instead.</li>
  <li>Part 2 is in the lending PR (2713) but not covered in the video
    <ol>
      <li>If the supply of RUNE is 500M (MaxRuneSupply Mimir) or greater, donâ€™t allow the creation of new loans.</li>
      <li>Canâ€™t find Mimir value in constants</li>
      <li>I put comment on the MR about this</li>
    </ol>
  </li>
</ol>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#cross-chain-swaps" class="page__taxonomy-item" rel="tag">Cross Chain Swaps</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#synths" class="page__taxonomy-item" rel="tag">Synths</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#thorfi-lending" class="page__taxonomy-item" rel="tag">THORFI Lending</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#defi" class="page__taxonomy-item" rel="tag">Defi</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#thorchain" class="page__taxonomy-item" rel="tag">THORChain</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#thorfi" class="page__taxonomy-item" rel="tag">THORFI</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-02-21T00:00:00+10:30">February 21, 2023</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/defi/thorchain/thorfi/THORFi-Risks-Explained/" class="pagination--pager" title="THORChain - THORFI Risks and Concerns Explained
">Previous</a>
    
    
      <a href="/defi/thorchain/thorfi/Lending-Guide/" class="pagination--pager" title="THORChain Lending
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <section id="static-comments">
        
      </section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/thorchain/Feburary-Update/" rel="permalink">THORChain Feburary Update
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I wanted create a post about THORChain as a lot has happened this year. The biggest update is regarding THORFi and there is a lot to unpack, so I will leave ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/thorchain/rujira/thorchain-rujitrade/" rel="permalink">THORChain + Ruji Trade
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I made a video regarding Ruji Trade and how it is going to work. Also see below an updated version of the picture used.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/thorchain/thorchain-cosmos/" rel="permalink">THORChain + Cosmos Update
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A lot is happening with THORChain, so Iâ€™ve been doing research to understand it better. I wanted to dive deeper into COSMWASM, IBC, and the upcoming Kujira p...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/beginner/smsf-bitcoin/" rel="permalink">Bitcoin in SMSF
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I have done some write up for friends insterested in having Bitcoin in their SMSF so I have cleaned it up a bit and shared in on my website.

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/GrassRootsio" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
      
        
          <li><a href="https://t.me/GrassRootsCrypto" rel="nofollow noopener noreferrer"><i class="fab fa-telegram-plane" aria-hidden="true"></i> Telegram</a></li>
        
      
        
          <li><a href="https://www.youtube.com/c/grassrootscrypto" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> Youtube</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 GrassRoots Crypto. <a href="/disclaimer/" rel="nofollow">Copyright. All Rights Reserved</a> </div>


      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NH9NNXEF3M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NH9NNXEF3M', { 'anonymize_ip': false});
</script>






    

  





  </body>
</html>
